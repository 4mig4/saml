<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<head>
    <title>lua-resty-saml</title>
    <link rel="stylesheet" href="../ldoc.css" type="text/css" />
</head>
<body>

<div id="container">

<div id="product">
	<div id="product_logo"></div>
	<div id="product_name"><big><b></b></big></div>
	<div id="product_description"></div>
</div> <!-- id="product" -->


<div id="main">


<!-- Menu -->

<div id="navigation">
<br/>
<h1>ldoc</h1>

<ul>
  <li><a href="../index.html">Index</a></li>
</ul>



<h2>Examples</h2>
<ul class="nowrap">
  <li><strong>identity_provider.lua</strong></li>
  <li><a href="../examples/service_provider.lua.html">service_provider.lua</a></li>
  <li><a href="../examples/utils.lua.html">utils.lua</a></li>
</ul>
<h2>Modules</h2>
<ul class="nowrap">
  <li><a href="../modules/resty.saml.binding.html">resty.saml.binding</a></li>
  <li><a href="../modules/resty.saml.html">resty.saml</a></li>
  <li><a href="../modules/saml.html">saml</a></li>
</ul>
<h2>Topics</h2>
<ul class="">
  <li><a href="../topics/00-Introduction.md.html">00-Introduction</a></li>
  <li><a href="../topics/01-Installation.md.html">01-Installation</a></li>
  <li><a href="../topics/02-Organization.md.html">02-Organization</a></li>
</ul>

</div>

<div id="content">

    <h2>identity_provider.lua</h2>
<pre>
<span class="keyword">local</span> saml  = <span class="global">require</span> <span class="string">"resty.saml"</span>
<span class="keyword">local</span> utils = <span class="global">require</span> <span class="string">"utils"</span>

<span class="keyword">local</span> _M = {}

<span class="keyword">local</span> RSA_SHA_512_TRANSFORM = <span class="global">assert</span>(saml.find_transform_by_href(<span class="string">"http://www.w3.org/2001/04/xmldsig-more#rsa-sha512"</span>))

<span class="keyword">local</span> SIGNING_KEY = <span class="global">assert</span>(saml.key_read_file(<span class="string">"/ssl/idp.key"</span>, saml.KeyDataFormatPem))
<span class="keyword">local</span> SIGNING_CERT = <span class="global">assert</span>(saml.key_read_file(<span class="string">"/ssl/idp.crt"</span>, saml.KeyDataFormatCertPem))
<span class="keyword">if</span> <span class="keyword">not</span> saml.key_add_cert_file(SIGNING_KEY, <span class="string">"/ssl/idp.crt"</span>, saml.KeyDataFormatCertPem) <span class="keyword">then</span>
  <span class="global">assert</span>(<span class="keyword">nil</span>, <span class="string">"could not add cert to signing key"</span>)
<span class="keyword">end</span>

<span class="keyword">local</span> SP_CERT = <span class="global">assert</span>(saml.key_read_file(<span class="string">"/ssl/sp.crt"</span>, saml.KeyDataFormatCertPem))

<span class="keyword">local</span> SP_URI = <span class="string">"http://localhost:8088"</span>
<span class="keyword">local</span> IDP_URI = <span class="string">"http://localhost:8089"</span>

<span class="keyword">local</span> <span class="keyword">function</span> cert_from_doc(doc)
  <span class="keyword">local</span> issuer = saml.doc_issuer(doc)
  <span class="keyword">if</span> issuer == SP_URI <span class="keyword">then</span>
    <span class="keyword">return</span> SP_CERT
  <span class="keyword">else</span>
    ngx.log(ngx.WARN, <span class="string">"issuer "</span> .. <span class="global">tostring</span>(issuer) .. <span class="string">" not recognized"</span>)
    <span class="keyword">return</span> <span class="keyword">nil</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">local</span> RESPONSE = <span class="string">[[
&lt;samlp:Response xmlns:samlp="urn:oasis:names:tc:SAML:2.0:protocol" xmlns:saml="urn:oasis:names:tc:SAML:2.0:assertion" ID="${uuid}" Version="2.0" IssueInstant="${issue_instant}" Destination="${destination}" InResponseTo="${in_response_to}"&gt;
  &lt;saml:Issuer&gt;${issuer}&lt;/saml:Issuer&gt;
  &lt;samlp:Status&gt;
    &lt;samlp:StatusCode Value="${status}"/&gt;
  &lt;/samlp:Status&gt;
  &lt;saml:Assertion xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xs="http://www.w3.org/2001/XMLSchema" ID="assertion-${uuid}" Version="2.0" IssueInstant="${issue_instant}"&gt;
    &lt;saml:Issuer&gt;${issuer}&lt;/saml:Issuer&gt;
    &lt;saml:AttributeStatement&gt;
      &lt;saml:Attribute Name="username" NameFormat="urn:oasis:names:tc:SAML:2.0:attrname-format:basic"&gt;
        &lt;saml:AttributeValue xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xs:string"&gt;world&lt;/saml:AttributeValue&gt;
      &lt;/saml:Attribute&gt;
    &lt;/saml:AttributeStatement&gt;
  &lt;/saml:Assertion&gt;
&lt;/samlp:Response&gt;
]]</span>

<span class="keyword">local</span> <span class="keyword">function</span> response(destination, in_response_to, status)
  <span class="keyword">return</span> utils.interp(RESPONSE, {
    destination = destination,
    in_response_to = in_response_to,
    issue_instant = <span class="global">os</span>.date(<span class="string">"!%Y-%m-%dT%TZ"</span>),
    issuer = IDP_URI,
    status = status,
    uuid = <span class="string">"id-"</span> .. <span class="global">math</span>.random(<span class="number">1</span>, <span class="number">100</span>),
  })
<span class="keyword">end</span>

<span class="keyword">local</span> LOGOUT_RESPONSE = <span class="string">[[
&lt;samlp:LogoutResponse xmlns:samlp="urn:oasis:names:tc:SAML:2.0:protocol" xmlns:saml="urn:oasis:names:tc:SAML:2.0:assertion" ID="${uuid}" Version="2.0" IssueInstant="${issue_instant}" Destination="${destination}" InResponseTo="${in_response_to}"&gt;
  &lt;saml:Issuer&gt;${issuer}&lt;/saml:Issuer&gt;
  &lt;samlp:Status&gt;
    &lt;samlp:StatusCode Value="${status}"/&gt;
  &lt;/samlp:Status&gt;
&lt;/samlp:LogoutResponse&gt;
]]</span>

<span class="keyword">local</span> <span class="keyword">function</span> logout_response(destination, in_response_to, status)
  <span class="keyword">return</span> utils.interp(LOGOUT_RESPONSE, {
    destination = destination,
    in_response_to = in_response_to,
    issue_instant = <span class="global">os</span>.date(<span class="string">"!%Y-%m-%dT%TZ"</span>),
    issuer = IDP_URI,
    status = status,
    uuid = <span class="string">"id-"</span> .. <span class="global">math</span>.random(<span class="number">1</span>, <span class="number">100</span>),
  })
<span class="keyword">end</span>

<span class="keyword">function</span> _M:sso(relay_state)
  <span class="keyword">local</span> doc, args, err = saml.binding.parse_redirect(<span class="string">"SAMLRequest"</span>, cert_from_doc)

  <span class="keyword">local</span> request_id = <span class="string">""</span>
  <span class="keyword">if</span> doc <span class="keyword">then</span>
    request_id = saml.doc_id(doc)
    saml.doc_free(doc)
  <span class="keyword">end</span>

  <span class="keyword">local</span> status
  <span class="keyword">if</span> err <span class="keyword">then</span>
    ngx.log(ngx.WARN, err)
    status = saml.STATUS_CODES_REQUESTER
  <span class="keyword">else</span>
    status = saml.STATUS_CODES_SUCCESS
  <span class="keyword">end</span>

  <span class="keyword">local</span> dest = SP_URI .. <span class="string">"/acs"</span>

  <span class="keyword">local</span> body, err = saml.binding.create_post(SIGNING_KEY, RSA_SHA_512_TRANSFORM, dest, {
    SAMLResponse = response(dest, request_id, status),
    RelayState = args.RelayState
  })
  <span class="keyword">if</span> err <span class="keyword">then</span>
    ngx.log(ngx.ERR, err)
    ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
  <span class="keyword">end</span>

  ngx.header.cache_control = <span class="string">"no-cache, no-store"</span>
  ngx.header.pragma = <span class="string">"no-cache"</span>
  ngx.header.content_type = <span class="string">"text/html"</span>
  ngx.header.content_length = #body
  ngx.say(body)
  ngx.exit(ngx.HTTP_OK)
<span class="keyword">end</span>

<span class="keyword">function</span> _M:sls(relay_state)
  <span class="keyword">local</span> doc, args, err = saml.binding.parse_redirect(<span class="string">"SAMLRequest"</span>, cert_from_doc)

  <span class="keyword">local</span> request_id = <span class="string">""</span>
  <span class="keyword">if</span> doc <span class="keyword">then</span>
    request_id = saml.doc_id(doc)
    saml.doc_free(doc)
  <span class="keyword">end</span>

  <span class="keyword">local</span> status
  <span class="keyword">if</span> err <span class="keyword">then</span>
    ngx.log(ngx.WARN, err)
    status = saml.STATUS_CODES_REQUESTER
  <span class="keyword">else</span>
    status = saml.STATUS_CODES_SUCCESS
  <span class="keyword">end</span>

  <span class="keyword">local</span> dest = SP_URI .. <span class="string">"/acs"</span>

  <span class="keyword">local</span> body, err = saml.binding.create_post(SIGNING_KEY, RSA_SHA_512_TRANSFORM, dest, {
    SAMLResponse = logout_response(dest, request_id, status),
    RelayState = args.RelayState
  })
  <span class="keyword">if</span> err <span class="keyword">then</span>
    ngx.log(ngx.ERR, err)
    ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
  <span class="keyword">end</span>

  ngx.header.cache_control = <span class="string">"no-cache, no-store"</span>
  ngx.header.pragma = <span class="string">"no-cache"</span>
  ngx.header.content_type = <span class="string">"text/html"</span>
  ngx.header.content_length = #body
  ngx.say(body)
  ngx.exit(ngx.HTTP_OK)
<span class="keyword">end</span>

<span class="keyword">return</span> _M</pre>


</div> <!-- id="content" -->
</div> <!-- id="main" -->
<div id="about">
<i>generated by <a href="http://github.com/stevedonovan/LDoc">LDoc 1.4.6</a></i>
<i style="float:right;">Last updated 2019-06-17 19:15:59 </i>
</div> <!-- id="about" -->
</div> <!-- id="container" -->
</body>
</html>
